name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  terraform:
    name: Terraform fmt & validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.0

      - name: Terraform fmt
        run: terraform fmt -check -recursive

      - name: Terraform init (AWS)
        run: terraform -chdir=terraform/aws init -backend=false

      - name: Terraform validate (AWS)
        run: terraform -chdir=terraform/aws validate

      - name: Terraform init (GCP)
        run: terraform -chdir=terraform/gcp init -backend=false

      - name: Terraform validate (GCP)
        run: terraform -chdir=terraform/gcp validate

  k3s-test:
    name: k3s smoke test
    runs-on: ubuntu-latest
    needs: terraform
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up k3d (k3s)
        uses: AbsaOSS/k3d-action@v2
        with:
          cluster-name: ntp-ci
          args: "--agents 1"

      - name: Verify cluster nodes
        run: kubectl get nodes

      - name: Apply k8s manifests (server dry-run)
        run: |
          if [ -d "k8s" ]; then
            kubectl apply -f k8s/ --dry-run=server
          else
            echo "No k8s directory found; skipping manifest dry-run."
          fi

  ansible:
    name: Ansible k3s playbook check
    runs-on: ubuntu-latest
    needs: terraform
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Ansible
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ansible

      - name: Ansible --version
        run: ansible --version

      - name: Syntax-check k3s playbook
        run: ansible-playbook -i ansible/inventory.example.ini ansible/k3s.yml --syntax-check
